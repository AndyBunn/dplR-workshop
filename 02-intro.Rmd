# Using dplR

This document describes basic features of `dplR` by following the initial steps that an analyst might follow when working with a new tree-ring data set. The  document starts with reading in ring widths and plotting them. We describe a few of the available methods for detrending and then show how to extract basic descriptive statistics. We show how to build and plot a simple  mean-value chronology. We also show how to build a chronology  using the expressed population signal from the detrended ring widths as an example of how more complicated analysis can be done using `dplR`.

## What is Covered

The Dendrochronology Program Library in R (`dplR`) is a package for  dendrochronologists to handle data processing and analysis. This document gives just a brief introduction of some of the most commonly used functions in `dplR`. There is more detailed information available in the help files and in the literature [@Bunn2008]. 

In this document, we will walk through the most basic activities of working  with tree-ring data in roughly the order that a user might follow. E.g.,  reading data, detrending, chronology building, and doing preliminary  exploratory data analysis via descriptive statistics.

### Load dplR

We will be using `dplR` in here. Load it:

```{r}
library(dplR)
```


## Working with Ring-Width Data

### Reading Data

There are many ways that tree-ring data are digitally stored. These range in sophistication from the simple (and commonly used) [Tucson/decadal](http://www1.ncdc.noaa.gov/pub/data/paleo/treering/treeinfo.txt) format file of ring widths to the more complex (but richer) [TRiDaS format](http://www.tridas.org/). The type of data used most often by dendrochronologists is a series of ring widths from tree cores. We generally refer to these as  `rwl` objects for "ring width length" but there is no reason these cannot be other types of tree-ring data (e.g., density).

The workhorse function for getting tree-ring data into R is dplR's `read.rwl` function. This function reads files in `"tucson"`, `"compact"`, `"tridas"`, and `"heidelberg"` formats. The on-board `rwl` data sets in `dplR` (i.e., `co021`, `ca533`, `gp.rwl`) were all imported into R using this function.

Throughout this document we will use the on-board data set  `ca533` which gives the raw ring widths for bristlecone pine *Pinus longaeva* at Campito Mountain in California, USA. There are 34 series spanning 1358 years. 

These objects are structured very simply as a `data.frame` with the series in columns and the years as rows. The series IDs are the column names and the years are the row names (both stored as characters). For instance, using the Campito Mountain ring widths we can load the data and learn some basic things about it:

```{r}
data(ca533) # the result of ca533 <- read.rwl('ca533.rwl')
nrow(ca533) # 1358 years
ncol(ca533) # 34 series
```

We can look a little deeper at this object (`ca533`) and get the series names as well as look at the time values associates with the data:

```{r}
colnames(ca533) # the series IDs
head(time(ca533),n = 10) # the first 10 years
```

### Describing and Plotting Ring-Width Data

Once a `rwl` data set has been read into R, there are a variety of ways to describe and visualize those data. Take note that this object is stored both as a generic `data.frame` in R but it also is part of a special class called `rwl` which will let R know how to do some special things with it like summarize and plot the data: 

```{r}
class(ca533) 
```

Thus, we can plot a `rwl` object by showing either the segments arranged over time as straight lines or as a "spaghetti plot". The `rwl` objects have generic S3 methods for `plot` and `summary` meaning that `R` knows how to do something special when `plot` or `summary` are invoked on an object with class `rwl`. E.g.,:

```{r}
plot(ca533, plot.type="spag")
```


## Descriptive Statistics

The simplest report on a `rwl` object can be print to the screen via:
```{r}
rwl.report(ca533)
```

That's pretty basic information. We can look at some common (and not-so common) descriptive statistics of a `rwl` object:

```{r}
ca533.stats <- summary(ca533) # same as calling rwl.stats(ca533)
head(ca533.stats,n=5) # look at the first five series
```

These are common summary statistics like mean, median, etc. but also statistics that are more specific to dendrochronology like the first-order autocorrelation (`ar1`), gini (`gini`), and mean sensitivity (`sens1` and `sens2`). **We would be remiss if we did not here mention that mean sensitivity is actually a terrible statistic that should rarely, if ever, be used [@Bunn2013].** Note that output object `ca533.stats` is itself a `data.frame` and its data can be used to plot, etc.

For instance, we can look at the spread of the first-order autocorrelation via `summary(ca533.stats$ar1)` or make a plot to show the data. Here we will demonstrate a somewhat involved plot to get you an idea of how to layer plotting commands:

```{r,fig.height=5, fig.width=5}
boxplot(ca533.stats$ar1,ylab=expression(phi[1]),col = "lightblue")
stripchart(ca533.stats$ar1, vertical = TRUE,  
    method = "jitter", jitter = 0.02,add = TRUE, pch = 20, col = 'darkblue',cex=1.25)
ar1Quant <- quantile(ca533.stats$ar1,probs = c(0.25,0.5,0.75))
abline(h=ar1Quant,lty="dashed",col="grey")
mtext(text = names(ar1Quant),side = 4,at = ar1Quant,las=2)
```

Quick editorial note. I've switched from base R plotting to using `ggplot` in most all of my work. I need to go through and provide new plotting examples for everything, but time is short. Real quick though, here is a `ggplot`

```{r,fig.width=2,fig.height=4}
library(ggplot2)
ar1 <- data.frame(x="CA 533",y=ca533.stats$ar1)
ggplot(ar1,aes(x,y)) + geom_boxplot(width=.2) +
  geom_jitter(width=0.1) + 
  labs(y=expression(phi[1]),x=element_blank()) +
  theme_minimal()
```

## Detrending

Analysts often (but not always) detrend a `rwl` data set to create an object containing ring-width index (`rwi`) values. The `dplR` package contains most standard detrending methods including detrending via splines, fitting negative exponential curves, and so on. There are also `dplR` functions for less commonly used detrending methods like regional curve and signal-free standardization.

A `rwi` object has the same basic properties as the `rwl` object from which it is made. I.e., it has the same number of rows and columns, the same names, and so on. The difference is that each series has been standardized by dividing the ring widths against a growth model (e.g., a stiff spline, a negative  exponential, etc.). This gives each series a mean of one (thus referred to as "indexed") and allows a chronology to be built (next section). As `read.rwl` is the primary function for getting data into R,  `detrend` is the primary function for standardizing `rwl` objects (but see `cms`, `rcs`, `bai.in`, and  `bai.out` as well).

### Common Detrending Methods

As any dendrochronologist will tell you, detrending is a dark art. In `dplR` we have implemented some of the standard tools for detrending but all have drawbacks. In all of the methods, the detrending is the estimation and removal of the low frequency variability that is due to biological or stand  effects. The standardization is done by dividing each series by the growth  trend to produce units in the dimensionless ring-width index (RWI). Much of the text that follows is modified from the help page of `detrend`.

Probably the most common method for detrending is what is often called the "conservative" approach of attempting to fit a negative exponential curve to a series. In the `dplR` implementation the `"ModNegExp"` method of `detrend` attempts to fit a classic nonlinear model of biological growth of the form $(f(t) = a \times \mathrm{e}^{bt} + k)$, where the argument of the function is time, using `nls`. See Fritts [-@Fritts2001] for details about the parameters. If a suitable nonlinear model cannot be fit (function is non-decreasing or some values are not positive) then a linear model is fit using `lm`. That linear model can have a positive slope unless `pos.slope` is `FALSE` in which case the series is standardized by its mean (method `"Mean"` in `detrend`).

For instance, every series in the `ca533` object can be detrended at once via:  

```{r, warning = FALSE}
ca533.rwi <- detrend(rwl = ca533, method = "ModNegExp")
```

This saves the results in `ca533.rwi` which is a `data.frame` with the same dimensions as the `rwl` object `ca533` and each series standardized.
```{r}
nrow(ca533.rwi) # 1358 years
ncol(ca533.rwi) # 34 series
colMeans(ca533.rwi, na.rm=TRUE)
```

When `detrend` is run on a `rwl` object the function loops through 
each series. It does this by calling a different function 
(`detrend.series`) for each column in the `rwl` object. 
But, a user can also call `detrend.series` and it is useful to do so here 
for educational purposes.

Let us detrend a single series and apply more than one detrending method when we call the detrend function. We will call `detrend.series` using the verbose mode so that we can see the parameters applied for each method. The `detrend.series` function produces a plot by default.

```{r, warning = FALSE}
CAM011.rwi <- detrend.series(y = ca533[, "CAM011"],verbose=TRUE)
```

Note that advanced users can use `return.info=TRUE` to have all the curve-fitting parameters returned in a `list`. Having access to these curves is occasionally desirable. Also, sometimes a user will want to interactively detrend each series and fit a negative exponential curve to one series, a spline to another, and the mean to a third. This can be done via the `i.detrend` and `i.detrend.series` functions. See their help pages for details. Users can also power transform tree-ring data (`powt`) and detrend via subtraction instead of division using `detrend` and `detrend.series`.

### Other Detrending Methods

There are other detrending methods that are less commonly used but might have theoretical advantages. These include regional curve standardization (function `rcs`), C-Method Standardization (function `cms`), and converting measurements of ring widths to basal area increment (functions  `bai.in` and `bai.out`). See their help pages for further information.

## Descriptive Statistics for Detrended Data

It is also easy in `dplR` to compute commonly used descriptive statistics that describe the correlation between series (both within and between tree correlations) as well as the expressed population signal, signal-to-noise ratio, and subsample signal strength for a data set. These are done in `dplR` using the `rwi.stats` function so-named because these statistics are typically (but not always) carried out on detrended and standardized ring widths (rwi). If a data set has more than one core taken per tree this information can be used in the calculations to calculate within vs. between tree correlation. The function `read.ids` is used to identify which trees have multiple cores. 

```{r}
ca533.ids <- read.ids(ca533, stc = c(3, 2, 1))
rwi.stats(ca533.rwi, ca533.ids, prewhiten=TRUE)
```

There is (at least) one other way of looking at the average interseries correlation of a data set. The `interseries.cor` function in `dplR` gives a measure of average interseries correlation that is different from the rbar statistics from `rwi.stats`. In this function, correlations are calculated serially between each tree-ring series and a master chronology built from all the other series in the `rwl` object (leave-one-out principle). The average of those correlations is sometimes called the "overall interseries correlation" or even the "COFECHA correlation" in reference to commonly used crossdating software COFECHA. This number is typically higher than the various rbar values given by  `rwi.stats`. We are showing just the first five series and the mean for all series here:

```{r}
ca533.rho <- interseries.cor(ca533.rwi, prewhiten=TRUE,
                             method="spearman")
ca533.rho[1:5, ]
mean(ca533.rho[, 1])
```

Again, if these concepts are unknown to you statistically look at some of the canonical works in dendrochronology like @Cook1990, @Fritts2001, and @Hughes2011.

## Building a Mean-Value Chronology

After detrending, a user will typically build a chronology by averaging across the years of the rwi object. In `dplR` the function for doing this is `chron` which by default uses Tukey's biweight robust mean (an average that is unaffected by outliers).

```{r}
ca533.crn <- chron(ca533.rwi)
```

This object has the same number of rows as the rwi object that was used as the input and two columns. The first gives the chronology and the second the sample depth (the number of series available in that year).

```{r}
dim(ca533.rwi)
dim(ca533.crn)
```

An object produced by `chron` has a generic S3 method for plotting which calls the `crn.plot` function (which has many arguments for customization). Here we will just make a simple plot of the chronology with a smoothing spline (function `caps`) added.

```{r}
plot(ca533.crn, add.spline=TRUE, nyrs=20)
```

The `chron` function is the most basic (and most common) way to buld a chronology but there are many other ways as we will see in the next few chapters.

## Conclusion

In general this page aims to give a very cursory overview of basic tasks that most dendrochronologists will want to be aware of. Know that we are just scratching the surface of what `dplR` is capable of. Browsing the list of functions in `dplR` will give you an idea of what else is available.

```{r,eval=FALSE}
?dplR
```

